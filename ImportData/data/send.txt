public partial class CompanyPage : UserControl
{
    private int _pageSize = 5;
    private int _currentPage = 1;
    private List<Company> _allCompanies {get; set;}
    private List<Company> _filteredCompanies {get; set;}
    private User _currentUser;
    private MainWindow _mainWindow;
    public CompanyPage()
    {
        InitializeComponent();
        LoadAllCompanies();
    }
    public CompanyPage(User currentUser, MainWindow mainWindow) : this()
    {
        _currentUser = currentUser;
        _mainWindow = mainWindow;

        DataContext = this;
        
        InitializeActionColumn();
        ApplyPagination();

        CreateCompany_btn.IsVisible = currentUser.Role == "Менеджер";
    }
    private void LoadAllCompanies()
    {
        using var db = new DataWorker();
        _allCompanies = db.GetAllCompanies();
        _filteredCompanies = _allCompanies;
    }
    private void ReloadCompanies()
    {
        LoadAllCompanies();
        ResetPagination();
        ApplyPagination();
    }
    private void ApplySearchFilter(string searchText)
    {
        if (string.IsNullOrWhiteSpace(searchText))
        {
            _filteredCompanies = _allCompanies;
        }
        else
        {
            _filteredCompanies = _allCompanies
                .Where(c => c.CompanyName
                .Contains(searchText, StringComparison.OrdinalIgnoreCase))
                .ToList();
        }
        ResetPagination();
        ApplyPagination();
    }
    private void ResetSearchFilter()
    {
        SearchTB.Text = string.Empty;
    }
    private void ApplyPagination()
    {
        Company_dg.ItemsSource = new ObservableCollection<Company>(_filteredCompanies.Skip((_currentPage - 1) * _pageSize).Take(_pageSize));
        currentPageTb.Text=_currentPage.ToString();
    }
    private void ResetPagination()
    {
        _currentPage = 1;
    }
    private void InitializeActionColumn()
    {
        var actionColumn = Company_dg.Columns.OfType<DataGridTemplateColumn>().FirstOrDefault(c => c.Header?.ToString() == "Настройка статуса");
        if (actionColumn == null)
            return;
        actionColumn.CellTemplate = CreateActionTemplate();
    }
    private IDataTemplate CreateActionTemplate()
    {
        return new FuncDataTemplate<Company>((company, _) =>
        {
            var panel = new StackPanel
            {
                Orientation = Avalonia.Layout.Orientation.Horizontal, 
                Spacing = 4
            };
            var activateBTN = new Button
            {
                Content="Активировать",
                IsVisible = _currentUser.Role == "Менеджер" && company.Status == "Привязка пользователя"
            };
            var blockBTN = new Button
            {
                Content="Заблокировать",
                IsVisible = _currentUser.Role == "Менеджер" && company.Status == "Активно"
            };
            activateBTN.Click += ActivateCompanyBtn_Click;
            blockBTN.Click += BlockBtn_Click;
            panel.Children.Add(activateBTN);
            panel.Children.Add(blockBTN);
            return panel;
        });
    }
    //Create company
    private void CreateCompanyBtn_Click(object? sender, RoutedEventArgs e)
    {
        var window = new CreateCompanyWindow();
        window.CompanyCreated += ReloadCompanies;
        window.ShowDialog(_mainWindow);
        SearchTB.Text = string.Empty;
    }
    //Change size page
    private void PageSizeCB_SelectionChanged(object? sender, SelectionChangedEventArgs e)
    {
        if (!IsInitialized || sender is not ComboBox comboBox)
            return;
        _pageSize = comboBox.SelectedIndex
        switch
        {
            0 => 5,
            1 => 10,
            _ => _filteredCompanies.Count
        };
        ResetPagination();
        ApplyPagination();
    }
    //Search by company name
    private void SearchTB_TextChanged(object? sender, TextChangedEventArgs e)
    {
        if (!IsInitialized || sender is not TextBox textBox)
            return;

        ApplySearchFilter(textBox.Text);
    }
    
    //Companies buttons click
    public void DeleteCompanyBtn_Click(object? sender, RoutedEventArgs e)
    {
        if (sender is not Button {DataContext: Company company})
            return;
        using var dataWorker = new DataWorker();
        dataWorker.DeleteCompany(company.CompanyCode);
        ResetSearchFilter();
        LoadAllCompanies();
        ApplyPagination();
    }
    public void BlockBtn_Click(object? sender, RoutedEventArgs e)
    {
        if (sender is not Button {DataContext: Company company})
            return;
        using var dataWorker = new DataWorker();
        dataWorker.UpdateCompanyStatus(company.CompanyCode, "Заблокировано");
        LoadAllCompanies();
        ApplyPagination();
    }
    public void ActivateCompanyBtn_Click(object? sender, RoutedEventArgs e)
    {
        if (sender is not Button {DataContext: Company company})
            return;
        using var dataWorker = new DataWorker();
        dataWorker.UpdateCompanyStatus(company.CompanyCode, "Активно");
        LoadAllCompanies();
        ApplyPagination();
    }

    //Next and back page
    private bool CanMoveToNextPage()
    {
        return _currentPage * _pageSize < _filteredCompanies.Count();
    }
    private void NextPageBtn_Click(object? sender, RoutedEventArgs e)
    {
        if (!CanMoveToNextPage())
            return;
        _currentPage ++;
        ApplyPagination();
    }
    private void BackPageBtn_Click(object? sender, RoutedEventArgs e)
    {
        if (_currentPage <= 1)
            return;
        _currentPage --;
        ApplyPagination();
    }

}